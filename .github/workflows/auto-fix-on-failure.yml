name: Auto-Fix on PR Check Failure

on:
  workflow_run:
    workflows: ["Python Tests and Linting", "Lint"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

# Serialize auto-fix runs per branch so that simultaneous CI failures
# (e.g. "Python Tests and Linting" + "Lint" both failing) don't race
# to push conflicting commits or inflate retry counters.
concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  auto-fix:
    name: Auto-Fix PR Check Failures
    runs-on: ubuntu-latest
    # Only run when a workflow fails and it was triggered by a pull request
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      # ‚îÄ‚îÄ Step 1: Find PR and count existing auto-fix attempts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Find PR and Check Retry Counts
        id: check-retry
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            const headBranch = workflowRun.head_branch;

            console.log(`Looking for PR with head branch: ${headBranch}`);

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const pr = pulls.find(p => p.head.ref === headBranch);

            if (!pr) {
              console.log('No open PR found for this workflow run');
              core.setOutput('found_pr', 'false');
              return;
            }

            console.log(`Found PR #${pr.number}: ${pr.title}`);

            // Skip fork PRs ‚Äî cannot push to forks
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log('PR is from a fork ‚Äî skipping auto-fix (cannot push to forks)');
              core.setOutput('found_pr', 'false');
              return;
            }

            core.setOutput('found_pr', 'true');
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_branch', headBranch);

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const tier1Count = comments.filter(c => c.body && c.body.includes('<!-- auto-fix-push -->')).length;
            const exhaustionPosted = comments.some(c => c.body && c.body.includes('<!-- auto-fix-exhausted -->'));

            console.log(`Tier 1 (ruff) attempts so far: ${tier1Count}`);
            console.log(`Exhaustion notice already posted: ${exhaustionPosted}`);

            const tier1Max = 3;

            core.setOutput('tier1_count', tier1Count);
            core.setOutput('tier1_remaining', tier1Count < tier1Max ? 'true' : 'false');
            core.setOutput('exhausted', tier1Count >= tier1Max ? 'true' : 'false');
            core.setOutput('exhaustion_posted', exhaustionPosted ? 'true' : 'false');

      # ‚îÄ‚îÄ Step 2: Tier 1 ‚Äî ruff auto-fix (direct commit + push) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout PR Branch
        if: steps.check-retry.outputs.found_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check-retry.outputs.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Tier 1 ‚Äî ruff auto-fix
        id: ruff-fix
        if: >
          steps.check-retry.outputs.found_pr == 'true' &&
          steps.check-retry.outputs.tier1_remaining == 'true'
        run: |
          python -m pip install --quiet ruff
          ruff check --fix . || true
          ruff format .
          if git diff --quiet; then
            echo "No changes made by ruff"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "ruff made changes"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push ruff fixes
        id: ruff-push
        if: steps.ruff-fix.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: auto-fix lint issues with ruff"
          git push origin HEAD
          echo "pushed=true" >> "$GITHUB_OUTPUT"

      - name: Post Tier 1 comment
        if: steps.ruff-push.outputs.pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-retry.outputs.pr_number }}', 10);
            const tier1Count = parseInt('${{ steps.check-retry.outputs.tier1_count }}', 10) + 1;
            const workflowRun = context.payload.workflow_run;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '<!-- auto-fix-push -->',
                '## üîß Auto-Fix: ruff (Tier 1)',
                '',
                `**Attempt**: ${tier1Count} of 3`,
                `**Triggered by**: [${workflowRun.name} #${workflowRun.run_number}](${workflowRun.html_url})`,
                '',
                'Applied `ruff check --fix` and `ruff format` and pushed the changes directly to this branch.',
                '',
                '---',
                '_Automated fix by the auto-fix workflow._'
              ].join('\n')
            });

      # ‚îÄ‚îÄ Step 3: Exhaustion notice ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Post exhaustion notice
        if: >
          steps.check-retry.outputs.found_pr == 'true' &&
          steps.check-retry.outputs.exhausted == 'true' &&
          steps.check-retry.outputs.exhaustion_posted != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-retry.outputs.pr_number }}', 10);
            const workflowRun = context.payload.workflow_run;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '<!-- auto-fix-exhausted -->',
                '## ‚ö†Ô∏è Auto-Fix Exhausted ‚Äî Human Intervention Required',
                '',
                'Auto-fix has been exhausted (3 ruff attempts).',
                '',
                '**A human review is now required.**',
                '',
                `**Failed Workflow**: [${workflowRun.name} #${workflowRun.run_number}](${workflowRun.html_url})`,
                '',
                '### Next Steps',
                '',
                '1. Review the [workflow logs](' + workflowRun.html_url + ') to understand the failures',
                '2. Run `bash scripts/run-pr-checks.sh` locally to reproduce the errors',
                '3. Fix the issues and push your changes',
                '',
                '---',
                '_Automated notice from the auto-fix workflow._'
              ].join('\n')
            });
