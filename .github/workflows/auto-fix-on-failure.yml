name: Auto-Fix on PR Check Failure

on:
  workflow_run:
    workflows: ["Python Tests and Linting", "Lint"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

# Serialize auto-fix runs per branch so that simultaneous CI failures
# (e.g. "Python Tests and Linting" + "Lint" both failing) don't race
# to push conflicting commits or inflate retry counters.
concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  auto-fix:
    name: Auto-Fix PR Check Failures
    runs-on: ubuntu-latest
    # Only run when a workflow fails and it was triggered by a pull request
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      # ‚îÄ‚îÄ Step 1: Find PR and count existing auto-fix attempts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Find PR and Check Retry Counts
        id: check-retry
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            const headBranch = workflowRun.head_branch;

            console.log(`Looking for PR with head branch: ${headBranch}`);

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const pr = pulls.find(p => p.head.ref === headBranch);

            if (!pr) {
              console.log('No open PR found for this workflow run');
              core.setOutput('found_pr', 'false');
              return;
            }

            console.log(`Found PR #${pr.number}: ${pr.title}`);

            // Skip fork PRs ‚Äî cannot push to forks
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log('PR is from a fork ‚Äî skipping auto-fix (cannot push to forks)');
              core.setOutput('found_pr', 'false');
              return;
            }

            core.setOutput('found_pr', 'true');
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_branch', headBranch);

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const tier1Count = comments.filter(c => c.body && c.body.includes('<!-- auto-fix-push -->')).length;
            const tier2Count = comments.filter(c => c.body && c.body.includes('<!-- auto-fix-copilot-cli -->')).length;
            const exhaustionPosted = comments.some(c => c.body && c.body.includes('<!-- auto-fix-exhausted -->'));

            console.log(`Tier 1 (ruff) attempts so far: ${tier1Count}`);
            console.log(`Tier 2 (Copilot CLI) attempts so far: ${tier2Count}`);
            console.log(`Exhaustion notice already posted: ${exhaustionPosted}`);

            const tier1Max = 3;
            const tier2Max = 2;

            core.setOutput('tier1_count', tier1Count);
            core.setOutput('tier2_count', tier2Count);
            core.setOutput('tier1_remaining', tier1Count < tier1Max ? 'true' : 'false');
            core.setOutput('tier2_remaining', tier2Count < tier2Max ? 'true' : 'false');
            core.setOutput('exhausted', (tier1Count >= tier1Max && tier2Count >= tier2Max) ? 'true' : 'false');
            core.setOutput('exhaustion_posted', exhaustionPosted ? 'true' : 'false');

      # ‚îÄ‚îÄ Step 2: Tier 1 ‚Äî ruff auto-fix (direct commit + push) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout PR Branch
        if: steps.check-retry.outputs.found_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check-retry.outputs.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Tier 1 ‚Äî ruff auto-fix
        id: ruff-fix
        if: >
          steps.check-retry.outputs.found_pr == 'true' &&
          steps.check-retry.outputs.tier1_remaining == 'true'
        run: |
          python -m pip install --quiet ruff
          ruff check --fix . || true
          ruff format .
          if git diff --quiet; then
            echo "No changes made by ruff"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "ruff made changes"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push ruff fixes
        id: ruff-push
        if: steps.ruff-fix.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: auto-fix lint issues with ruff"
          git push origin HEAD
          echo "pushed=true" >> "$GITHUB_OUTPUT"

      - name: Post Tier 1 comment
        if: steps.ruff-push.outputs.pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-retry.outputs.pr_number }}', 10);
            const tier1Count = parseInt('${{ steps.check-retry.outputs.tier1_count }}', 10) + 1;
            const workflowRun = context.payload.workflow_run;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '<!-- auto-fix-push -->',
                '## üîß Auto-Fix: ruff (Tier 1)',
                '',
                `**Attempt**: ${tier1Count} of 3`,
                `**Triggered by**: [${workflowRun.name} #${workflowRun.run_number}](${workflowRun.html_url})`,
                '',
                'Applied `ruff check --fix` and `ruff format` and pushed the changes directly to this branch.',
                '',
                '---',
                '_Automated fix by the auto-fix workflow._'
              ].join('\n')
            });

      # ‚îÄ‚îÄ Step 3: Tier 2 ‚Äî Copilot CLI headless fix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Security note: this step only runs for same-repo PRs (fork PRs have
      # found_pr=false set in step 1). pip install -e ".[dev]" installs PR code,
      # which carries the same trust level as what the test CI already executes.
      - name: Tier 2 ‚Äî Copilot CLI headless fix
        id: copilot-fix
        if: >
          steps.check-retry.outputs.found_pr == 'true' &&
          steps.ruff-push.outputs.pushed != 'true' &&
          steps.check-retry.outputs.tier2_remaining == 'true'
        # Required secrets:
        #   COPILOT_AGENT_PAT ‚Äî a GitHub personal access token used by Copilot CLI
        #   and for authenticated git operations in this step.
        #   Configure at: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
        env:
          COPILOT_AGENT_PAT: ${{ secrets.COPILOT_AGENT_PAT }}
          GH_TOKEN: ${{ secrets.COPILOT_AGENT_PAT }}
        run: |
          python -m pip install --quiet -e ".[dev]"
          npm install -g @githubnext/copilot-cli 2>/dev/null || true

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Capture current errors to include in the prompt
          RUFF_ERRORS=$(ruff check . 2>&1 || true)
          PYTEST_ERRORS=$(python -m pytest --tb=short -q 2>&1 | tail -50 || true)
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"

          # Write the prompt to a temp file to avoid quoting/special-character issues
          PROMPT_FILE=$(mktemp)
          trap 'rm -f "$PROMPT_FILE"' EXIT
          {
            printf 'CI checks failed on this pull request.\n'
            printf 'Workflow run: %s\n\n' "${WORKFLOW_URL}"
            printf 'Current ruff errors:\n%s\n\n' "${RUFF_ERRORS}"
            printf 'Current pytest errors (last 50 lines):\n%s\n\n' "${PYTEST_ERRORS}"
            printf 'Please fix the source code so all checks pass:\n'
            printf '1. Run "bash scripts/run-pr-checks.sh" to see the exact errors\n'
            printf '2. Fix the source code\n'
            printf '3. Re-run "bash scripts/run-pr-checks.sh" to verify all checks pass\n'
            printf '4. Commit and push directly to this branch using "git push origin HEAD"\n\n'
            printf 'Do NOT create a new PR. Push directly to the current branch.\n'
          } > "$PROMPT_FILE"

          # Record commit SHA before Copilot runs so we can detect if it pushed
          PRE_SHA=$(git rev-parse HEAD)

          if command -v copilot >/dev/null 2>&1; then
            timeout 30m copilot -p "$(cat "$PROMPT_FILE")" -s --no-ask-user --allow-all-tools || true
          else
            echo "Copilot CLI not available ‚Äî skipping Tier 2 headless session"
          fi

          # Check if Copilot pushed new commits
          POST_SHA=$(git rev-parse HEAD)
          if [ "$PRE_SHA" != "$POST_SHA" ]; then
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          # Safety net: if Copilot left uncommitted changes, commit and push them
          elif ! git diff --quiet || ! git diff --cached --quiet; then
            git add -A
            git commit -m "chore: auto-fix via Copilot CLI"
            git push origin HEAD
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          else
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post Tier 2 comment
        if: steps.copilot-fix.outputs.pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-retry.outputs.pr_number }}', 10);
            const tier2Count = parseInt('${{ steps.check-retry.outputs.tier2_count }}', 10) + 1;
            const workflowRun = context.payload.workflow_run;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '<!-- auto-fix-copilot-cli -->',
                '## ü§ñ Auto-Fix: Copilot CLI (Tier 2)',
                '',
                `**Attempt**: ${tier2Count} of 2`,
                `**Triggered by**: [${workflowRun.name} #${workflowRun.run_number}](${workflowRun.html_url})`,
                '',
                'Ran the Copilot CLI in headless mode to diagnose and fix the failures. Changes pushed directly to this branch.',
                '',
                '---',
                '_Automated fix by the auto-fix workflow._'
              ].join('\n')
            });

      # ‚îÄ‚îÄ Step 4: Exhaustion notice ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Post exhaustion notice
        if: >
          steps.check-retry.outputs.found_pr == 'true' &&
          steps.check-retry.outputs.exhausted == 'true' &&
          steps.check-retry.outputs.exhaustion_posted != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-retry.outputs.pr_number }}', 10);
            const workflowRun = context.payload.workflow_run;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '<!-- auto-fix-exhausted -->',
                '## ‚ö†Ô∏è Auto-Fix Exhausted ‚Äî Human Intervention Required',
                '',
                'Both auto-fix tiers have been exhausted (3 ruff attempts + 2 Copilot CLI attempts).',
                '',
                '**A human review is now required.**',
                '',
                `**Failed Workflow**: [${workflowRun.name} #${workflowRun.run_number}](${workflowRun.html_url})`,
                '',
                '### Next Steps',
                '',
                '1. Review the [workflow logs](' + workflowRun.html_url + ') to understand the failures',
                '2. Run `bash scripts/run-pr-checks.sh` locally to reproduce the errors',
                '3. Fix the issues and push your changes',
                '',
                '---',
                '_Automated notice from the auto-fix workflow._'
              ].join('\n')
            });
