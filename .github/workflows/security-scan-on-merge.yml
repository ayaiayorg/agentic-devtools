name: Security Scan on Main Merge

on:
  push:
    branches:
      - main

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  security-scan:
    name: Run Security Scanning Agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          # Install security scanning tools
          pip install bandit safety pip-audit

      - name: Get Merge Information
        id: merge-info
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha;
            console.log(`Current commit SHA: ${commitSha}`);
            
            // Get the commit details
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: commitSha
            });
            
            console.log(`Commit message: ${commit.commit.message}`);
            console.log(`Author: ${commit.commit.author.name}`);
            
            // Check if this is a merge commit
            const isMerge = commit.parents.length > 1;
            console.log(`Is merge commit: ${isMerge}`);
            
            core.setOutput('commit_sha', commitSha);
            core.setOutput('commit_message', commit.commit.message);
            core.setOutput('is_merge', isMerge);
            
            // Try to find associated PR using GitHub API
            let prNumber = null;
            let prTitle = '';
            let prUrl = '';
            
            try {
              // Use the API to list PRs associated with this commit
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitSha
              });
              
              if (prs.length > 0) {
                // Take the first merged PR
                const pr = prs.find(p => p.merged_at) || prs[0];
                prNumber = pr.number;
                prTitle = pr.title;
                prUrl = pr.html_url;
                console.log(`Found associated PR via API: #${prNumber} - ${prTitle}`);
              }
            } catch (error) {
              console.log(`Could not fetch associated PRs via API: ${error.message}`);
            }
            
            // Fallback: try to parse PR number from commit message
            if (!prNumber && isMerge) {
              const prMatch = commit.commit.message.match(/#(\d+)/);
              if (prMatch) {
                prNumber = parseInt(prMatch[1]);
                console.log(`Found PR number from commit message: ${prNumber}`);
                
                // Get PR details
                try {
                  const { data: pr } = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber
                  });
                  
                  prTitle = pr.title;
                  prUrl = pr.html_url;
                  console.log(`Fetched PR details: #${prNumber} - ${prTitle}`);
                } catch (error) {
                  console.log(`Could not fetch PR details: ${error.message}`);
                }
              }
            }
            
            if (prNumber) {
              core.setOutput('pr_number', prNumber);
              core.setOutput('pr_title', prTitle);
              core.setOutput('pr_url', prUrl);
            }

      - name: Run Dependency Vulnerability Scan
        id: pip-audit
        run: |
          echo "Running pip-audit..."
          pip-audit --format json > pip-audit-report.json || true
          
          # Check if vulnerabilities were actually found by parsing JSON
          if [ -s pip-audit-report.json ]; then
            vuln_count=$(python -c "import json; data=json.load(open('pip-audit-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
            if [ "$vuln_count" -gt 0 ]; then
              echo "Dependency vulnerabilities found: $vuln_count vulnerability(ies)"
              pip-audit || true
            else
              echo "No dependency vulnerabilities found"
            fi
          else
            echo "pip-audit did not produce a report"
          fi
        continue-on-error: true

      - name: Run Bandit Security Scanner
        id: bandit
        run: |
          echo "Running bandit security scanner..."
          bandit -r agentic_devtools -f json -o bandit-report.json || true
          
          # Check if issues were actually found by parsing JSON
          if [ -s bandit-report.json ]; then
            issue_count=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len(data.get('results', [])))" 2>/dev/null || echo "0")
            if [ "$issue_count" -gt 0 ]; then
              echo "Security issues found: $issue_count issue(s)"
              bandit -r agentic_devtools -f screen || true
            else
              echo "No security issues found by bandit"
            fi
          else
            echo "Bandit did not produce a report"
          fi
        continue-on-error: true

      - name: Run Safety Scan
        id: safety
        env:
          SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
        run: |
          echo "Running safety scan..."
          safety scan --json > safety-report.json 2>&1; safety_exit_code=$?

          # Validate that the report is non-empty and parseable JSON
          if [ ! -s safety-report.json ]; then
            echo "Safety scan did not produce a report (exit code: ${safety_exit_code})"
            echo '{"vulnerabilities": []}' > safety-report.json
          elif ! python -c "import json; json.load(open('safety-report.json'))" 2>/dev/null; then
            echo "Safety scan produced non-JSON output (exit code: ${safety_exit_code}) - likely requires authentication or encountered an error"
            echo "--- safety output ---"
            cat safety-report.json
            echo "--- end safety output ---"
            # Replace with empty valid JSON so downstream steps are not affected
            echo '{"vulnerabilities": []}' > safety-report.json
          else
            if [ "${safety_exit_code}" -eq 0 ]; then
              echo "No vulnerabilities found by safety"
            else
              echo "Vulnerabilities or issues reported by safety (exit code: ${safety_exit_code}) - see safety-report.json"
              safety scan || true
            fi
          fi
        continue-on-error: true

      - name: Create Security Scan Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commitSha = '${{ steps.merge-info.outputs.commit_sha }}';
            const isMerge = '${{ steps.merge-info.outputs.is_merge }}' === 'true';
            const prNumber = '${{ steps.merge-info.outputs.pr_number }}';
            const prTitle = ${{ toJson(steps.merge-info.outputs.pr_title) }};
            const prUrl = ${{ toJson(steps.merge-info.outputs.pr_url) }};
            
            // Read scan results
            let pipAuditResults = 'No vulnerabilities detected';
            let banditResults = 'No issues detected';
            let safetyResults = 'No vulnerabilities detected';
            
            try {
              if (fs.existsSync('pip-audit-report.json')) {
                const pipAudit = JSON.parse(fs.readFileSync('pip-audit-report.json', 'utf8'));
                if (pipAudit.vulnerabilities && pipAudit.vulnerabilities.length > 0) {
                  pipAuditResults = `Found ${pipAudit.vulnerabilities.length} vulnerability(ies)`;
                }
              }
            } catch (e) {
              console.log('Could not read pip-audit results:', e.message);
            }
            
            try {
              if (fs.existsSync('bandit-report.json')) {
                const bandit = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
                if (bandit.results && bandit.results.length > 0) {
                  const critical = bandit.results.filter(r => r.issue_severity === 'HIGH').length;
                  const medium = bandit.results.filter(r => r.issue_severity === 'MEDIUM').length;
                  const low = bandit.results.filter(r => r.issue_severity === 'LOW').length;
                  banditResults = `Found ${bandit.results.length} issue(s): ${critical} high, ${medium} medium, ${low} low`;
                }
              }
            } catch (e) {
              console.log('Could not read bandit results:', e.message);
            }
            
            try {
              if (fs.existsSync('safety-report.json')) {
                const safety = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
                if (safety.vulnerabilities && safety.vulnerabilities.length > 0) {
                  safetyResults = `Found ${safety.vulnerabilities.length} vulnerability(ies)`;
                }
              }
            } catch (e) {
              console.log('Could not read safety results:', e.message);
            }
            
            // Determine if there are any findings
            const hasFindings = 
              pipAuditResults.includes('Found') || 
              banditResults.includes('Found') || 
              safetyResults.includes('Found');
            
            // Skip issue creation entirely when there are no findings
            if (!hasFindings) {
              console.log('No security findings detected - skipping issue creation.');
              return;
            }
            
            // Build issue body
            let issueBody = [
              '<!-- security-scan-report -->',
              '',
              '# ðŸ”’ Security Scan Report',
              '',
              '**Date**: ' + new Date().toISOString().split('T')[0],
              '**Commit**: ' + commitSha.substring(0, 7),
              '**Branch**: main',
              ''
            ];
            
            if (isMerge && prNumber) {
              issueBody.push(`**Merged PR**: [#${prNumber} - ${prTitle}](${prUrl})`);
              issueBody.push('');
            }
            
            issueBody.push('## Summary');
            issueBody.push('');
            issueBody.push('âš ï¸ **Security findings detected** - review required.');
            issueBody.push('');
            issueBody.push('## Scan Results');
            issueBody.push('');
            issueBody.push('### Dependency Vulnerabilities (pip-audit)');
            issueBody.push('');
            issueBody.push(pipAuditResults);
            issueBody.push('');
            issueBody.push('### Static Security Analysis (bandit)');
            issueBody.push('');
            issueBody.push(banditResults);
            issueBody.push('');
            issueBody.push('### Dependency Safety Check (safety)');
            issueBody.push('');
            issueBody.push(safetyResults);
            issueBody.push('');
            issueBody.push('## Next Steps');
            issueBody.push('');
            issueBody.push('1. Review the [workflow logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for detailed findings');
            issueBody.push('2. Address critical and high-severity issues immediately');
            issueBody.push('3. Create tickets for medium-priority items');
            issueBody.push('4. Tag @copilot for assistance with remediation');
            issueBody.push('');
            issueBody.push('---');
            issueBody.push('');
            issueBody.push('*Automated security scan performed by the Security Scanning Agent*');
            issueBody.push('*View [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for full details*');
            
            const issueTitle = 'ðŸ”’ Security Scan Report - Findings Detected';
            
            // Check for an existing open issue with the same title to avoid duplicates.
            // Use the search API with an exact title query to avoid race conditions from
            // concurrent workflow runs both calling listForRepo and finding no match.
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${issueTitle}"`;
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: searchQuery,
              per_page: 100
            });
            
            const existingIssue = searchResults.items.find(i => i.title === issueTitle);
            
            if (existingIssue) {
              // Add a comment to the existing issue instead of creating a duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody.join('\n')
              });
              console.log(`Updated existing issue #${existingIssue.number} with new scan results`);
              console.log(`Issue URL: ${existingIssue.html_url}`);
            } else {
              // No existing open issue â€” create a new one
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody.join('\n'),
                labels: ['security', 'security-scan', 'needs-review']
              });
              console.log(`Created issue #${issue.number}: ${issue.title}`);
              console.log(`Issue URL: ${issue.html_url}`);
            }

      - name: Upload Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-reports
          path: |
            pip-audit-report.json
            bandit-report.json
            safety-report.json
          retention-days: 90
