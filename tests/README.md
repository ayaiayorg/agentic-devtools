# Test Organization Policy

This document defines the strict 1:1:1 test organization policy for `agentic-devtools`.
All new tests **must** follow this policy. No exceptions are allowed.

## Policy

- **One folder per source file under test** — the test directory structure mirrors the source structure.
- **One test file per function under test** — each test file covers exactly one function.

## Directory Structure

```text
tests/unit/{module_path}/{source_file_name}/test_{symbol_name}.py
```

where `{symbol_name}` is:

- **Functions**: the exact snake\_case function name (e.g., `get_current_branch` → `test_get_current_branch.py`)
- **Classes / dataclasses / enums**: the class name lowercased **without** additional underscores
  (e.g., `WorktreeSetupResult` → `test_worktreesetupresult.py`, `ChecklistItem` → `test_checklistitem.py`)

### Example

| Source symbol | Test file |
|---|---|
| `agentic_devtools/cli/git/core.py` → `get_current_branch()` | `tests/unit/cli/git/core/test_get_current_branch.py` |
| `agentic_devtools/state.py` → `get_value()` | `tests/unit/state/test_get_value.py` |
| `agentic_devtools/cli/jira/config.py` → `get_jira_url()` | `tests/unit/cli/jira/config/test_get_jira_url.py` |
| `agentic_devtools/cli/workflows/worktree_setup.py` → `WorktreeSetupResult` | `tests/unit/cli/workflows/worktree_setup/test_worktreesetupresult.py` |
| `agentic_devtools/cli/workflows/checklist.py` → `ChecklistItem` | `tests/unit/cli/workflows/checklist/test_checklistitem.py` |

## Rules

1. The path under `tests/unit/` **must** mirror the path under `agentic_devtools/` exactly
   (drop the `agentic_devtools/` prefix and strip the `.py` extension to form the folder name).
2. The test file **must** be named `test_{symbol_name}.py` where `{symbol_name}` is:
   - For **functions**: the exact snake\_case function name.
   - For **classes / dataclasses / enums**: the class name lowercased without added underscores
     (e.g., `WorktreeSetupResult` → `test_worktreesetupresult.py`).
3. **Each test file tests exactly one symbol (function or class).** If a source file has ten
   public symbols, it will have ten corresponding test files inside its folder.
4. Every directory in the hierarchy **must** contain an `__init__.py` file so pytest can
   resolve imports correctly.

## Enforcement

A CI validation script (`scripts/validate_test_structure.py`) automatically checks that
every file inside `tests/unit/` obeys the rules above. The script exits with a non-zero
status if any violation is found, causing the CI build to fail.

To run the validator locally:

```bash
python scripts/validate_test_structure.py
```

## Top-Level Source Files

Source files directly inside `agentic_devtools/` (e.g., `state.py`, `background_tasks.py`)
map to `tests/unit/{source_file_name}/test_{function_name}.py`. The `module_path` part is
simply empty.

| Source | Test |
|--------|------|
| `agentic_devtools/state.py` → `get_workflow_state()` | `tests/unit/state/test_get_workflow_state.py` |
| `agentic_devtools/background_tasks.py` → `run_function_in_background()` | `tests/unit/background_tasks/test_run_function_in_background.py` |

> **Do NOT** create proxy/stub source files (e.g., `agentic_devtools/root/state.py`) just to
> add a path component. The validator supports 2-component minimum paths, so top-level
> source files are handled correctly without any workaround.

## Linting Requirements

All test files under `tests/unit/` must pass `ruff` linting. Common pitfalls to avoid:

1. **No unused imports (F401):** Each test file should only import what it actually uses.
   Ruff will flag any import that is never referenced in the file. Run `ruff check tests/unit/`
   or `ruff check tests/unit/ --fix` to auto-remove them.
   This is especially important when migrating tests from old flat files: the original preamble
   carries every import the old file needed, but the new per-function file may only need a subset.

2. **Sorted imports (I001):** Imports must be sorted (isort-style). The project uses
   `known-first-party = ["agentic_devtools", "agdt_ai_helpers"]`. Run `ruff check tests/unit/ --fix`
   to auto-sort them.

3. **No trailing whitespace:** Blank lines inside function/class bodies must not contain
   spaces. Ruff's `W291`/`W293` rules catch this. Use `ruff format` or `ruff check --fix` to clean up.

4. **Do not commit `agentic_devtools/_version.py`:** This file is auto-generated by
   setuptools-scm and must never be committed. It is **untracked by git** and listed in
   `.gitignore`, so `git add .` will never stage it. No manual cleanup is needed — you
   should **not** run `git checkout -- agentic_devtools/_version.py` or
   `git update-index --skip-worktree`; those older instructions are obsolete now that
   `_version.py` is untracked and ignored by `.gitignore`.

5. **Verify the source file path before placing tests:** The test location must mirror the
   *actual* source file path. For example, a function defined in `review_helpers.py` belongs
   under `tests/unit/cli/azure_devops/review_helpers/`, **not** `review_prompts/`. Always
   check the `from ... import` statement to confirm the correct source module.

6. **Always call `mkdir()` when a test needs an existing-but-empty directory:** When writing
   tests for code that checks whether a directory exists, make sure to actually create the
   directory with `tmp_path / "subdir"` followed by `.mkdir()`. Skipping the call means
   the test exercises the *missing-directory* code path instead of the *empty-directory* code
   path, leading to a misleading test name and untested branch.

7. **Remove unused fixture parameters:** Fixtures like `capsys` capture output but only add
   overhead when the test body never calls them (e.g., `capsys.readouterr()`). Code reviewers
   will flag unused parameters. Remove any fixture from the signature that the test body does
   not use.

**Run these commands before every push to catch all issues:**

```bash
ruff check tests/unit/ --fix    # fix unused imports and import sorting
ruff format tests/unit/         # fix formatting
python scripts/validate_test_structure.py  # verify 1:1:1 structure
```

## Existing Tests

Tests outside `tests/unit/` (e.g., `tests/azure_devops/`, `tests/e2e_smoke/`, and the
flat `tests/test_*.py` files) were written before this policy was introduced. They are
**not** validated by the 1:1:1 script and do not need to be migrated immediately.
New test code, however, **must** be placed under `tests/unit/`.
